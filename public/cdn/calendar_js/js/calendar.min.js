$.fn.calendar = function (options) {
    "use strict";

    return this.each(function () {

        function daysInMonth(year, month) {
            var feb = (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0)) ? 29 : 28;
            var arr = [31, feb, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            return arr[month];
        }

        function findEvents(events, day) {
            var found_events = [];
            if (events) {
                $.each(events, function () {
                    if (day.getTime() >= this.start.getTime() && day.getTime() <= this.end.getTime()) {
                        found_events.push(this);
                    }
                });
            }
            return found_events || false;
        }

        var defaults = {
            color: false,
            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            daysMin: ['DOM', 'LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB'],
            dayLetter: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
            events: false
        };

        options = options || {};
        var settings = $.extend(defaults, options);

        if (settings.events) {
            $.each(settings.events, function (index, value) {
                value.start = new Date(value.start);
                value.start.setHours(0, 0, 0, 0);
                value.end = new Date(value.end);
                value.end.setHours(0, 0, 0, 0);
                settings.events[index] = value;
            });
        }

        var date = settings.date ? new Date(settings.date) : new Date($(this).data("date"));
        if (isNaN(date.valueOf())) {
            date = new Date();
        }

        date.setDate(1);
        date.setHours(0, 0, 0, 0);

        var current_day = date;
        var today = new Date();
        today.setHours(0, 0, 0, 0);

        var total_days_in_month = daysInMonth(date.getFullYear(), date.getMonth());

        var thead = $('<thead/>')
            .append(
                $('<tr/>')
                    .addClass('calendar-title')
                    .append(
                        $('<th/>')
                            .attr('colspan', 7)
                            .text(settings.months[date.getMonth()] + ' ' + date.getFullYear())
                    )
            )
            .append(
                $('<tr/>')
                    .addClass('calendar-header')
                    .html('<th>' + settings.daysMin.join('</th><th>') + '</th>')
            );

        var tbody = '<tbody><tr>';

        var x;
        for (x = 0; x < date.getDay(); x += 1) {
            tbody += '<td class="pad"> </td>';
        }

        var day_count = 1;
        var today_class;
        var event_class;
        var events_found;
        var event_summary;

        while (day_count <= total_days_in_month) {
            events_found = findEvents(settings.events, current_day);

            today_class = current_day.getTime() === today.getTime() ? ' today' : '';
            event_class = '';
            event_summary = ' ';

            if (events_found) {
                $.each(events_found, function () {
                    if (this.start.getTime() === current_day.getTime()) {
                        event_class += this.mask ? ' mask-start' : '';
                        event_class += this.classes ? ' ' + this.classes : '';
                        event_summary += this.summary || '';
                    } else if (current_day.getTime() > this.start.getTime() && current_day.getTime() < this.end.getTime()) {
                        event_class += this.mask ? ' mask' : '';
                    } else if (current_day.getTime() === this.end.getTime()) {
                        event_class += this.mask ? ' mask-end' : '';
                    }
                });
            }

            tbody += '<td class="day' + event_class + today_class + '" title="' + event_summary + '">';
            tbody += '<div>' + current_day.getDate() + '</div>';
            tbody += '<div>' + event_summary + '</div>';
            tbody += '</td>';

            if (current_day.getDay() === 6) {
                tbody += '</tr>';
                if ((day_count + 1) <= total_days_in_month) {
                    tbody += '<tr>';
                }
            }

            current_day.setDate(date.getDate() + 1);
            day_count += 1;
        }

        var end_padding = 7 - current_day.getDay();

        if (end_padding && end_padding < 7) {
            for (x = 1; x <= end_padding; x += 1) {
                tbody += '<td class="pad"> </td>';
            }
        }

        var color_scheme = settings.color ? settings.color : '';

        $(this).html(
            $('<table/>')
                .addClass('calendar ' + color_scheme)
                .append(thead)
                .append(tbody)
        );

    });

};
